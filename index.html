<!DOCTYPE html >  
<html>  
<head>  
<title>Exercise 5 try 1</title>  
<meta charset="UTF-8">
<script type="text/javascript" src="dist/web3.min.js"></script>
</head>  
<body>  
<h1>DAPP Exercise</h1>
<div>
    <div id="container">
        <h4>Current Ropsten height</h4>
        <button onclick="getHeight()">get height</button>
        <span id ="heightSpan"></span>
    </div>
    <div id="container2">
        <h4>Current Token Balance</h4>
        <button onclick="getTokenBalance()">get balance</button>
        <span id ="tokenBalanceSpan"></span>
    </div>
    <div id="container3">
        <button class="enableEthereumButton">Enable Ethereum</button>
    </div>
</div>
<script  type="text/javascript">
    let web3 = new Web3(Web3.givenProvider || "ws://localhost:8545");
    var helper = 0;
    var tokenAcc = '0x7E3FaF43bf6F8cA3A7f0d40FC11d1DD908661D1F';
    const myAbi = [{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}];
    
    if (typeof window.ethereum !== 'undefined') {
        console.log('MetaMask is installed!');
    }
    
    async function getHeight(){
        let curHeight = await web3.eth.getBlockNumber();
        document.getElementById("heightSpan").innerText = curHeight;
    }

    async function getTokenBalance(){
        /*
        if(web3.eth.defaultAccount === undefined || web3.eth.defaultAccount === null){
            document.getElementById("tokenBalanceSpan").innerText = "please connect to metamask";
            return;
        }*/
        console.log(web3.eth.defaultAccount);
        var myContract = new web3.eth.Contract(myAbi,tokenAcc,{
            from: '0x1Cd7FA345BB0aDF48F03ADA419a6389A462E52cC'
        });
        await myContract.methods.balanceOf().call('0x1Cd7FA345BB0aDF48F03ADA419a6389A462E52cC').then(showTokenBalance(result));
    }

    function showTokenBalance(result){
        document.getElementById("tokenBalanceSpan").innerText = result;
    }

    //get meta mask input
    const ethereumButton = document.querySelector('.enableEthereumButton');

    ethereumButton.addEventListener('click', () => {
        getAccount();
    });

    async function getAccount() {
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        const account = accounts[0];
        //showAccount.innerHTML = account;
        web3.eth.defaultAccount = account;  //set default account after user input
        helper = 1;
    }


</script>  
</body>  
</html> 